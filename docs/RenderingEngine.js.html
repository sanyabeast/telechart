<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RenderingEngine.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ChartMath.html">ChartMath</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Config.html">Config</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EventBus..html">EventBus.</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="EventProxy.html">EventProxy</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MainLoop.html">MainLoop</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RenderingEngine.html">RenderingEngine</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Telechart.html">Telechart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Telechart.html#update">update</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="TelechartModule.html">TelechartModule</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Tweener..html">Tweener.</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Utils..html">Utils.</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#aggregation">aggregation</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">RenderingEngine.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Utils 			from "Telechart/Utils"
import ChartMath 		from "Telechart/Utils/ChartMath"
import TelechartModule 	from "Telechart/Utils/TelechartModule"
import DOMComponent from "Telechart/DomDriver/Component"

import RenderingObject 	from "Telechart/RenderingEngine/RenderingObject"
import Line 			from "Telechart/RenderingEngine/Line"
import Text 			from "Telechart/RenderingEngine/Text"
import Circle 			from "Telechart/RenderingEngine/Circle"
import Group 			from "Telechart/RenderingEngine/Group"
import DOMLayer 		from "Telechart/RenderingEngine/RenderingObject"

const DPR = window.devicePixelRatio
/**
 * @class
 * Canvas2D Rendering Engine
 *
 *
 */
class RenderingEngine extends Utils.aggregation( TelechartModule, RenderingObject ) {

	static RenderingObject = RenderingObject;
	static Line = Line;
	static Text = Text;
	static Circle = Circle;
	static Group = Group;
	static DOMLayer = DOMLayer;

	get domElement () { return this.$dom.canvasElement }
	get position () { return this.$state.position }
	get scale () { return this.$state.scale }
	get size () { return this.$state.size }

	constructor () {
		super()

		this.$modules = {
			canvas: new DOMComponent( {
				template: "canvas"
			} ),
			offscreenCanvas: new DOMComponent( {
				template: "canvas"
			} )
		}

		this.$dom = {
			canvasElement: this.$modules.canvas.domElement,
			offscreenCanvasElement: this.$modules.offscreenCanvas.domElement,
		}

		this.$temp = {
			position: ChartMath.vec2(0, 0),
			boundRect: ChartMath.rect(0, 0, 0, 0),
		}

		this.$state = {
			context2d: this.$dom.canvasElement.getContext( "2d" ),
			offscreenContext2d: this.$dom.offscreenCanvasElement.getContext( "2d" ),
			size: ChartMath.vec2( 100, 100 ),
			position: ChartMath.vec2( 0, 0 ),
			scale: ChartMath.vec2( 1, 1 ),
			viewportRect: ChartMath.rect( 0, 0, 0, 0 ),
			culledObjectsCount: 0,
			projectionModified: true,
			sizeNeedsUpdate: true
		}

		this.$tasks = {}

		this.render = this.render.bind(this)

		this.$updateProjectionState()
	}

	setScale ( x, y ) {
		this.$state.viewportRect.w = this.$state.size.x * x
		this.$state.viewportRect.h = this.$state.size.y * y

		this.$updateProjectionState()
	}

	setPosition (x, y ) {
		this.$state.position.x = x
		this.$state.position.y = y

		this.$updateProjectionState()
	}

	setViewport ( x, y, w, h ) {
		let vr = this.$state.viewportRect

		vr.x = x
		vr.y = y
		vr.w = w
		vr.h = h

		this.$updateProjectionState()
	} 

	setSize ( w, h ) {
		w *= DPR
		h *= DPR

		this.$dom.canvasElement.width = w
		this.$dom.canvasElement.height = h
		this.$dom.offscreenCanvasElement.width = w
		this.$dom.offscreenCanvasElement.height = h

		this.$state.size.x = w
		this.$state.size.y = h

		this.$updateProjectionState()
	}

	fitSize () {
		if ( this.$state.sizeNeedsUpdate &amp;&amp; this.domElement.parentElement ) {
			let rect = this.domElement.parentElement.getBoundingClientRect()
			this.setSize( rect.width, rect.height )
			this.$state.sizeNeedsUpdate = false
		}
	}

	prerender () {
		this.fitSize()
		this.$state.projectionModified = false;
		this.$state.culledObjectsCount = 0
		super.render( this, this.$state.offscreenContext2d, -this.$state.position.x, -this.$state.position.y )
	}

	render () {
		this.$state.context2d.clearRect( 0, 0, this.$state.size.x, this.$state.size.y )
		this.$state.offscreenContext2d.clearRect( 0, 0, this.$state.size.x, this.$state.size.y )

		this.prerender()

		this.$state.context2d.drawImage( this.$dom.offscreenCanvasElement, 0, 0 )
	}

	toReal ( x, y ) {
		let position = this.$temp.position

		position.x = (x - this.position.x) / this.scale.x
		position.y = this.size.y - ((y - this.position.y) / this.scale.y)

		return position
	}

	toVirtual ( x, y ) {
		let position = this.$temp.position

		position.x = ( ( x * this.scale.x ) + this.position.x )
		position.y = ( ( this.size.y - y ) + this.position.y ) * this.scale.y

		return position
	} 

	toVirtualScale ( x, y ) {
		let position = this.$temp.position

		position.x = (x) * this.scale.x
		position.y = (y) * this.scale.y

		return position
	}

	isCulled ( child, px, py ) {
		if ( !child.culled ) {
			return false
		} else {
			let boundRect = child.getBoundRect()
			let translatedRect = ChartMath.translateRect( this.$temp.boundRect, boundRect, px, py )
			child.projectionCulled = !ChartMath.rectIntersectsRect( translatedRect, this.$state.viewportRect )

			return child.projectionCulled
		}
	}

	$updateProjectionState () {
		let vr = this.$state.viewportRect

		this.$state.scale.x = vr.w / this.$state.size.x
		this.$state.scale.y = vr.h / this.$state.size.y
		vr.x = this.$state.position.x
		vr.y = this.$state.position.y

		this.$state.projectionModified = true
	}

	incrementCulledObjectsCount () { this.$state.culledObjectsCount++ }

}


export default RenderingEngine</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Mar 14 2019 19:59:06 GMT+0200 (GMT+02:00) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
